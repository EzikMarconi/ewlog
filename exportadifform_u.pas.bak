unit ExportAdifForm_u;

{$mode objfpc}{$H+}

interface

uses
  Classes, SysUtils, LCLType, FileUtil, Forms, Controls, Graphics, Dialogs,
  StdCtrls, EditBtn, ExtCtrls, process, sqldb;

type

  { TexportAdifForm }

  TexportAdifForm = class(TForm)
    Button1: TButton;
    Button2: TButton;
    CheckBox1: TCheckBox;
    CheckBox3: TCheckBox;
    DateEdit1: TDateEdit;
    DateEdit2: TDateEdit;
    Image1: TImage;
    Label1: TLabel;
    Label2: TLabel;
    Label3: TLabel;
    Label4: TLabel;
    Q1: TSQLQuery;
    RadioButton1: TRadioButton;
    rbFileExportAll: TRadioButton;
    SaveDialog1: TSaveDialog;
    procedure Button1Click(Sender: TObject);
    procedure Button2Click(Sender: TObject);
    procedure FormCreate(Sender: TObject);
    procedure FormShow(Sender: TObject);
    procedure RadioButton1Click(Sender: TObject);
    procedure rbFileExportAllClick(Sender: TObject);
  private
    FileName: string;
    ExportAll: boolean;
    MarkAfter: boolean;
    AProcess: TProcess;
    //FileSize : Int64;
    { private declarations }
  public
        function ExportToAdif: word;
    { public declarations }
  end;

var
  exportAdifForm: TexportAdifForm;

implementation

uses dmFunc_U, MainForm_U;

var
  IsFilter: boolean;
  DebugLevel: integer;

{$R *.lfm}

procedure TexportAdifForm.Button1Click(Sender: TObject);
begin
  if Button1.Caption = 'Готово' then
    exportAdifForm.Close
  else
  begin
    SaveDialog1.FileName := MainForm.DBLookupComboBox1.Text + '_' + FormatDateTime(
      'yyyy-mm-dd', now);
    SaveDialog1.Execute;
    if SaveDialog1.FileName = '' then
    begin
      Application.MessageBox('Пожалуйста укажите файл для экспорта!', 'Внимание!',
        mb_ok + mb_IconWarning);
      exit;
    end;
    ExportAll := rbFileExportAll.Checked;
    FileName := SysToUTF8(SaveDialog1.FileName);
    if CheckBox1.Checked = True then
      ExportToAdif
    else
      Application.MessageBox('Не выбран метод экспорта!', 'Внимание!',
        mb_ok + mb_IconWarning);
  end;
end;

procedure TexportAdifForm.Button2Click(Sender: TObject);
begin
  exportAdifForm.Close;
end;

procedure TexportAdifForm.FormCreate(Sender: TObject);
begin

end;

procedure TexportAdifForm.FormShow(Sender: TObject);
begin
  if DefaultDB = 'MySQL' then
  begin
    Q1.DataBase := MainForm.MySQLLOGDBConnection;
  end
  else
    Q1.DataBase := MainForm.SQLiteDBConnection;

  if rbFileExportAll.Checked = True then
  begin
    DateEdit1.Enabled := False;
    DateEdit2.Enabled := False;
  end;
  Button1.Caption := 'Экспорт';
  Label2.Caption := '';
  Label1.Caption := 'Количество связей: 0';
end;

procedure TexportAdifForm.RadioButton1Click(Sender: TObject);
begin
  if RadioButton1.Checked = True then
  begin
    DateEdit1.Enabled := True;
    DateEdit2.Enabled := True;
  end;
end;

procedure TexportAdifForm.rbFileExportAllClick(Sender: TObject);
begin
  if rbFileExportAll.Checked = True then
  begin
    DateEdit1.Enabled := False;
    DateEdit2.Enabled := False;
  end;
end;

function TexportAdifForm.ExportToAdif: word;
var
  f: TextFile;
  tmp: string = '';
  nr: integer = 1;
  i: integer;
  date, freq2: string;

begin

  if FileExists(FileName) then
    DeleteFile(FileName);

  AssignFile(f, FileName);
  {$i-}
  Rewrite(f);
  {$i+}
  Result := IOResult;
  if IOresult <> 0 then
  begin
    Application.MessageBox(PChar('Ошибка открытия файла : ' + IntToStr(IOResult)),
      'Ошибка', mb_ok + mb_IconError);
    exit;
  end;

  date := FormatDateTime('yyyy-mm-dd', now);
  Writeln(f, '<ADIF_VER:5>2.2.1');
  Writeln(f, 'ADIF export from EWLOG');
  Writeln(f, 'Copyright (C) 2015-2016 by EW8BAK');
  Writeln(f);
  Writeln(f, 'Internet: http://www.ew8bak.ru');
  Writeln(f, 'Generated date ' + date);
  Writeln(f);
  Writeln(f, '<EOH>');
  Q1.Close;

  if rbFileExportAll.Checked = True then
    Q1.SQL.Text := 'select * from ' + LogTable + ' ORDER BY UnUsedIndex ASC';


  if RadioButton1.Checked = True then
  begin
    if DefaultDB = 'MySQL' then
      Q1.SQL.Text := 'SELECT * FROM ' + LogTable + ' WHERE QSODate BETWEEN ' +
        '''' + FormatDateTime('yyyy-mm-dd', DateEdit1.Date) + '''' +
        ' and ' + '''' + FormatDateTime('yyyy-mm-dd', DateEdit2.Date) +
        '''' + ' ORDER BY UnUsedIndex ASC'
    else
      Q1.SQL.Text :=
        'SELECT * FROM '+ LogTable + ' WHERE '+
        'strftime(''%Y-%m-%d'',QSODate) BETWEEN ' +
        QuotedStr(FormatDateTime('yyyy-mm-dd', DateEdit1.Date)) +
        ' and ' + QuotedStr(FormatDateTime('yyyy-mm-dd', DateEdit2.Date)) +
        ' ORDER BY UnUsedIndex ASC';
  end; end;

  Q1.Open();
  try
    Q1.First;
    while not Q1.EOF do
    begin
      Label1.Caption := 'Количество связей: ' + IntToStr(Nr);
      if not ExportAll then
      begin
        if Q1.Fields.FieldByName('LoTWSent').AsString <> '' then
        begin
          Q1.Next;
          Continue;
        end;
      end;

      tmp := '<OPERATOR' + dmFunc.StringToADIF(
        dmFunc.RemoveSpaces(MainForm.DBLookupComboBox1.Text));
      Write(f, tmp);

      tmp := '<CALL' + dmFunc.StringToADIF(
        dmFunc.RemoveSpaces(Q1.Fields.FieldByName('CallSign').AsString));
      Write(f, tmp);

      tmp := FormatDateTime('yyyymmdd', Q1.Fields.FieldByName('QSODate').AsDateTime);
      tmp := '<QSO_DATE' + dmFunc.StringToADIF(tmp);
      Write(f, tmp);

      tmp := Q1.Fields.FieldByName('QSOTime').AsString;
      tmp := copy(tmp, 1, 2) + copy(tmp, 4, 2);
      tmp := '<TIME_ON' + dmFunc.StringToADIF(tmp);
      Write(f, tmp);

      tmp := Q1.Fields.FieldByName('QSOTime').AsString;
      tmp := copy(tmp, 1, 2) + copy(tmp, 4, 2);
      tmp := '<TIME_OFF' + dmFunc.StringToADIF(tmp);
      Write(f, tmp);

      tmp := '<MODE' + dmFunc.StringToADIF(Q1.Fields.FieldByName('QSOMode').AsString);
      Write(f, tmp);

      freq2 := Q1.Fields.FieldByName('QSOBand').AsString;

      if Length(freq2) = 10 then
      begin
        Delete(freq2, 10, Length(freq2));
        Delete(freq2, 9, Length(freq2));
        Delete(freq2, 8, Length(freq2));
      end;

      if Length(freq2) = 9 then
      begin
        Delete(freq2, 9, Length(freq2));
        Delete(freq2, 8, Length(freq2));
        Delete(freq2, 7, Length(freq2));
      end;

      if Length(freq2) = 8 then
      begin
        Delete(freq2, 8, Length(freq2));
        Delete(freq2, 7, Length(freq2));
        Delete(freq2, 6, Length(freq2));
      end;

      tmp := '<FREQ' + dmFunc.StringToADIF(freq2);
      Write(f, tmp);

      tmp := '<RST_SENT' + dmFunc.StringToADIF(Q1.Fields.FieldByName(
        'QSOReportSent').AsString);
      Write(f, tmp);

      tmp := '<STX' + dmFunc.StringToADIF(Q1.Fields.FieldByName('STX').AsString);
      Write(f, tmp);

      tmp := '<RST_RCVD' + dmFunc.StringToADIF(Q1.Fields.FieldByName(
        'QSOReportRecived').AsString);
      Write(f, tmp);

      tmp := '<SRX' + dmFunc.StringToADIF(Q1.Fields.FieldByName('SRX').AsString);
      Write(f, tmp);

      tmp := '<NAME' + dmFunc.StringToADIF(Q1.Fields.FieldByName(
        'OMName').AsString);
      Write(f, tmp);

      tmp := '<QTH' + dmFunc.StringToADIF(Q1.Fields.FieldByName('OMQTH').AsString);
      Write(f, tmp);

      tmp := '<GRIDSQUARE' + dmFunc.StringToADIF(Q1.Fields.FieldByName(
        'Grid').AsString);
      Write(f, tmp);

      tmp := '<PFX' + dmFunc.StringToADIF(Q1.Fields.FieldByName('WPX').AsString);
      Write(f, tmp);

      tmp := '<DXCC_PREF' + dmFunc.StringToADIF(Q1.Fields.FieldByName(
        'DXCCPrefix').AsString);
      Write(f, tmp);

      tmp := '<BAND' + dmFunc.StringToADIF(dmFunc.GetAdifBandFromFreq(
        Q1.Fields.FieldByName('QSOBand').AsString));
      Write(f, tmp);

      tmp := '<CQZ' + dmFunc.StringToADIF(Q1.Fields.FieldByName(
        'CQZone').AsString);
      Write(f, tmp);

      tmp := '<ITUZ' + dmFunc.StringToADIF(Q1.Fields.FieldByName(
        'ITUZone').AsString);
      Write(f, tmp);

      tmp := '<CONT' + dmFunc.StringToADIF(Q1.Fields.FieldByName(
        'Continent').AsString);
      Write(f, tmp);

      tmp := '<QSLMSG' + dmFunc.StringToADIF(Q1.Fields.FieldByName(
        'QSLInfo').AsString);
      Write(f, tmp);

      tmp := '<EQSL_QSL_RCVD' + dmFunc.StringToADIF(Q1.Fields.FieldByName(
        'QSLReceQSLcc').AsString);
      Write(f, tmp);

      if Q1.Fields.FieldByName('QSLSentDate').AsString <> '' then
      begin
        tmp := FormatDateTime('yyyymmdd', Q1.Fields.FieldByName('QSLSentDate').AsDateTime);
        tmp := '<QSLSDATE' + dmFunc.StringToADIF(tmp);
        Write(f, tmp);
      end;

      if Q1.Fields.FieldByName('QSLRecDate').AsString <> '' then
      begin
        tmp := FormatDateTime('yyyymmdd', Q1.Fields.FieldByName('QSLRecDate').AsDateTime);
        tmp := '<QSLRDATE' + dmFunc.StringToADIF(tmp);
        Write(f, tmp);
      end;

      tmp := '<QSL_RCVD' + dmFunc.StringToADIF(Q1.Fields.FieldByName(
        'QSLRec').AsString);
      Write(f, tmp);

      tmp := '<QSL_RCVD_VIA' + dmFunc.StringToADIF(Q1.Fields.FieldByName(
        'QSL_RCVD_VIA').AsString);
      Write(f, tmp);

      tmp := '<QSL_SENT_VIA' + dmFunc.StringToADIF(Q1.Fields.FieldByName(
        'QSL_SENT_VIA').AsString);
      Write(f, tmp);

      tmp := '<QSL_SENT' + dmFunc.StringToADIF(Q1.Fields.FieldByName(
        'QSLSent').AsString);
      Write(f, tmp);

      tmp := '<DXCC' + dmFunc.StringToADIF(Q1.Fields.FieldByName('DXCC').AsString);
      Write(f, tmp);

      tmp := '<COMMENT' + dmFunc.StringToADIF(Q1.Fields.FieldByName(
        'QSOAddInfo').AsString);
      Write(f, tmp);

      Write(f, '<EOR>');
      Writeln(f);
      if (nr mod 100 = 0) then
      begin
        Label1.Repaint;
        Application.ProcessMessages;
      end;
      Inc(nr);
      Q1.Next;
    end
  finally
    CloseFile(f);
    Label2.Caption := 'Готово';
    Button1.Caption := 'Готово';
  end;
end;

end.
